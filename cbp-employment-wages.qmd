# Employment and average wages

```{r}
#| label: setup
#| include: false

source("./scripts/setup.R")

data_label_size <- 3.5 # for plots using labels as data points

# for helpful sub-setting
top_naics_cutoff <- 5
top_county_cutoff <- 10

source("./scripts/define-reference-data.R")
source("./scripts/define-state-and-county-data.R")
source("./scripts/define-dataframes.R")

```

## NC employment by sector

In the state-level data for 2021 the CBP reported `r comma(sum(state_nc_workers_2021$emp))` workers in `r nrow(state_nc_workers_2021)` NAICS categories, which are summarized in @sec-tables.

```{r fig.height=6, fig.width=8}
#| label: fig-state-employment-by-sector-count
#| fig-height: 5
#| fig-width: 7
#| fig-cap: "NC state employment by sector 2021"
#| fig-alt: "This bar plot lists employment sectors on the Y axis with counts of the number of employees in North Carolina in each in 2021. This information is available in table form in the last sction of this page."

data_for_plot <- d_emp_sector_total_state_nc |>
  filter(year == 2021) |>
  mutate(naics_abbr = fct_reorder(naics_abbr, emp)) 

nc_naics_abbr_levels = levels(data_for_plot$naics_abbr)

data_for_plot |>
  ggplot() +
  geom_col(aes(x = emp, y = naics_abbr),
           fill = carolina_blue, alpha = 0.6) +
  scale_x_continuous(labels = label_number(scale_cut = cut_short_scale())) +
  labs(
    title = "NC state employment by sector 2021",
    subtitle = "Includes all 100 counties and 'Statewide'",
    x = "Employees",
    y = "",
    color = NULL,
    caption = my_caption
  )
```

<br>

The employment distribution across the sectors in NC and the USA overall is similar:

```{r fig.height=6, fig.width=8}
#| label: fig-state-employment-by-sector-pct-usa-compare
#| fig-height: 5
#| fig-width: 7
#| fig-cap: "NC employment by sector compared to USA 2021"
#| fig-alt: "This plot lists employment sectors on the Y axis with points indicating the percent of the employment in North Carolina and all 50 states. The percentages are similar for both."

data_for_plot <- bind_rows(
  d_emp_sector_total_state_nc |>
    filter(year == 2021) |>
    mutate(scope = "nc"),
  d_emp_sector_total_usa |>
    filter(year == 2021) |>
    mutate(scope = "usa")
) |>
  select(naics, naics_abbr, emp, pct_emp, scope) |>
  mutate(naics_abbr = factor(naics_abbr, levels = nc_naics_abbr_levels)) |>
  mutate(low_value = min(pct_emp),
         high_value = max(pct_emp),
         .by = naics_abbr) |>
  mutate(diff_pct = high_value - low_value,
         diff_pct = if_else(pct_emp == high_value, diff_pct, -1 * diff_pct)) 

diff_pct_cutoff <- 0.005

data_for_plot |>
  ggplot() +
  geom_segment(aes(x = low_value, xend = high_value, y = naics_abbr, yend = naics_abbr),
               alpha = 0.3) +
  geom_point(aes(x = pct_emp, y = naics_abbr, color = scope),
           alpha = 0.6) + 
  geom_point(aes(x = pct_emp, y = naics_abbr, color = scope),
           alpha = 0.6) + 
  geom_text(aes(x = high_value, y = naics_abbr,
                label = if_else(diff_pct > diff_pct_cutoff,
                                percent(pct_emp, accuracy = .1),
                                NA_character_)),
            na.rm = TRUE, size = 3,
            hjust = 0, nudge_x = 0.003) +
  geom_text(aes(x = low_value, y = naics_abbr,
                label = if_else(diff_pct < -1 * diff_pct_cutoff,
                                percent(pct_emp, accuracy = .1),
                                NA_character_)),
            na.rm = TRUE, size = 3,
            hjust = 1, nudge_x = -0.003) +
  scale_x_continuous(labels = label_percent()) +
  scale_color_manual(values = c(carolina_blue, "firebrick")) +
  theme(legend.position = c(0.8, 0.4),
        legend.box.background = element_rect(fill = "grey80")) +
  labs(
    title = "NC state employment by sector\ncompared to USA 2021",
    subtitle = glue("Includes all 100 counties and 'Statewide'", 
                    "; showing percentages where difference is > {percent(diff_pct_cutoff, accuracy = 0.1)}"),
    x = "Employees",
    y = "",
    color = NULL,
    caption = my_caption
  )

```

<br>

The CBP state data includes employee counts categorized by employee size class. The range is embedded in the name. For example, `e1_4` includes a count of employees working in establishments with 1-4 employees. Let's assume that the average number of workers in each employment size class is about the midpoint of the class, and for `e1000` ("1000 or more employees) that the midpoint is 2000. 

Then we can answer the question: from the perspective of workers, what are the most common employer size classes? Or asking another way: if one randomly selected a NC worker what is the probability the person would work in an establishment of a particular size class?

```{r fig.height=6, fig.width=12}
#| label: fig-state-workers
#| fig-height: 6
#| fig-width: 12
#| fig-cap: "NC workers in each employee size class 2021"
#| column: page-inset-right
#| fig-alt: "This bar chart lists employee size classes on the Y axis with percentage of employees in North Carolina in each in 2021. Size classes range from '1 to 4' up to '1000 or more'."

data_for_plot <- d_emp_state_nc_total_size_classes |>
  filter(year == 2021) |>
  inner_join(n_employees_ref |>
               select(-est_size_class),
             by = "emp_size_class")

p1 <- data_for_plot |>
  mutate(emp_size_class = fct_reorder(emp_size_class, factor_order)) |>
  ggplot() +
  geom_col(aes(x = pct_emp, y = emp_size_class),
           fill = carolina_blue, alpha = 0.6) +
  scale_x_continuous(labels = label_percent()) +
  scale_y_discrete(limits=rev) +
  labs(
    x = "Percent of employees",
    y = "Employee size class",
    color = NULL,
  )

p2 <- data_for_plot |>
  mutate(emp_size_class = fct_reorder(emp_size_class, pct_emp)) |>
  arrange(desc(emp_size_class)) |>
  mutate(cum_pct_emp = cumsum(pct_emp),
         ybar_start = lag(cum_pct_emp, default = 0)) |>
  ggplot() +
  geom_segment(aes(x = emp_size_class, xend = emp_size_class, y = ybar_start, yend = cum_pct_emp),
           color = carolina_blue, linewidth = 8, alpha = 0.6) + 
  scale_y_continuous(labels = label_percent()) +
  scale_x_discrete(limits=rev) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  labs(
    x = "Employee size class",
    y = "Percent of employees",
    color = NULL,
  )

p1 + p2 +
  plot_annotation(
    title = "Percent of NC employees working for establishments\nin each employee size class",
    subtitle = "2021; includes all sectors reported in CBP",
    caption = my_caption,
    #theme = theme(plot.title = element_text(size = 16))
  )
  
```

<br>

Further categorizing this data by industry sector reveals which industries have concentrations of workers in establishments of particular size classes. Employees in AccFood mostly work in establishments in the 10 to 100 employee range. In Retail there is a wider range: from very small to 499 employees and almost none larger. The industry sectors with the largest portion of employees working for the largest establishments are HeathSoc (hospital systems, I assume) and FinIns. Construction and ProfSciTech have the largest portion of employees in the sector working in 1-4 employee establishments.

```{r fig.height=8, fig.width=12}
#| label: fig-state-establishments-employees-naics-pct-two-plot
#| fig-height: 8
#| fig-width: 12
#| fig-cap: "Percent of NC workers in each employee size class by sector 2021"
#| column: page-inset-right
#| fig-alt: "This bar chart lists employee size classes on the Y axis with percentage of employees in North Carolina colored by industry sector. Data is for each in 2021. A second plot shows the same data spread out to show the distribution of industry sectors among the size classes. Two more plots provide similar information but with industry sectors on the Y axis."

data_for_plot <- d_emp_state_nc_size_classes |>
  filter(year == 2021) |>
  inner_join(n_employees_ref |>
               select(-est_size_class),
             by = "emp_size_class") |>
  mutate(emp_size_class = factor(emp_size_class, levels = emp_size_class_levels),
         naics_abbr = fct_lump(naics_abbr, n = 9, w = emp)) 

p1 <- data_for_plot |>
  ggplot() +
  geom_col(aes(x = pct_emp, y = emp_size_class, fill = naics_abbr),
           alpha = 0.6, show.legend = FALSE) +
  scale_x_continuous(labels = label_percent(accuracy = 1)) +
  scale_y_discrete(limits=rev) +
  labs(
    x = "Percent of employees",
    y = "Employee size class",
    color = NULL
  )

p2 <- data_for_plot |>
  ggplot() +
  geom_col(aes(x = pct_emp, y = emp_size_class, fill = naics_abbr),
           alpha = 0.6, position = position_fill()) +
  scale_x_continuous(labels = label_percent(accuracy = 1)) +
  scale_y_discrete(limits=rev) +
  labs(
    x = "Distibution of size classes",
    y = NULL,
    color = NULL
  )

p3 <- data_for_plot |>
  mutate(naics_abbr = fct_reorder(naics_abbr, emp, sum)) |>
  ggplot() +
  geom_col(aes(x = pct_emp, y = naics_abbr, fill = emp_size_class),
           alpha = 0.6, show.legend = FALSE) +
  scale_x_continuous(labels = label_percent(accuracy = 1)) +
  scale_fill_viridis_d(end = 0.85) +
  labs(
    x = "Percent of employees",
    y = NULL,
    color = NULL
  )

p4 <- data_for_plot |>
  mutate(naics_abbr = fct_reorder(naics_abbr, emp, sum)) |> 
  ggplot() +
  geom_col(aes(x = pct_emp, y = naics_abbr, fill = emp_size_class),
           alpha = 0.6, position = position_fill()) +
  scale_x_continuous(labels = label_percent(accuracy = 1)) +
  scale_fill_viridis_d(end = 0.85) +
  labs(
    x = "Distribution of NAICS categories",
    y = NULL,
    color = NULL
  )

(p1 + p2) / (p3 + p4) +
  plot_annotation(
    title = "Percent of NC workers in each employee size class by sector",
    subtitle = "2021; includes all sectors reported in CBP",
    caption = my_caption
  )
  
```

<br>

## Top sectors in largest NC counties

Are there similarities in the top sectors and their proportions in the counties with the most workers? Yes. HealthSoc, Retail, and AccFood are among the top four sectors in each of the top nine counties and the "Statewide" category. There are some differences: Mecklenburg's top sector is FinIns, Durham's is ProfSciTec, and Catawba's is Manuf.

```{r fig.height=10, fig.width=14}
#| label: fig-rank-employee-count-top-counties-pct
#| fig-height: 8
#| fig-width: 10
#| fig-cap: "Sector percent of country emplyment rank"
#| fig-alt: "This plot shows the top 5 sectors for the 10 largest counties by employment in North Carolina, from the largest (Mecklenburg) to the tenth-largest (Catawba). Lines connect the same industry sector in adjacent columns. The Y axis is the percent of county employment."

county_name_label <- d_emp_sector_total_county |> #d_sector_totals_county |>
  filter(year == 2021) |>
  select(year, fipscty, emp, county_name, naics) |>
  summarize(emp_sum = sum(emp),
            .by = county_name) |>
  slice_max(order_by = emp_sum, n = 10) |>
  mutate(county_name_label = glue("{county_name}\n{comma(emp_sum)}"),
         county_name_label = fct_reorder(county_name_label, -emp_sum))

data_for_plot <- d_nc_2021_top5_sectors_county_nc |>
  select(county_name, emp, naics, naics_descr, emp_rank) |>
  left_join(d_naics_abbr_ref,
             by = c("naics_descr")) |>
  left_join(county_name_label,
             by = c("county_name")) |>
  mutate(pct_emp = emp / emp_sum,
         county_name_label = fct_reorder(county_name_label, -emp, sum)) |>
  complete(county_name_label, naics_abbr, fill = list(emp = NA, pct_emp = NA)) 

data_for_plot |> 
  ggplot() +
  geom_line(aes(x = county_name_label, y = pct_emp, group = naics_abbr, color = naics_abbr),
            show.legend = FALSE, na.rm = TRUE) +
  geom_label(aes(x = county_name_label, y = pct_emp, label = naics_abbr, fill = naics_abbr),
             show.legend = FALSE, na.rm = TRUE, alpha = 0.4, size = data_label_size) +
  scale_x_discrete(position = "top") +
  scale_y_continuous(labels = label_percent()) +
  coord_cartesian(ylim = c(NA, 0.30)) +
  theme(axis.text.x = element_text(size = 10)) +
  labs(
    title = "Top 5 sectors in 10 largest NC counties:\npercent of county employment",
    subtitle = glue("Ordered by total county employment reported in CBP",
                    "; 'Statewide' refers to employees not associated with one county",
                    "\nNot showing Statewide AdminWaste, since it's over 50% of all 'Statewide' employees"),
    x = "",
    y = "Percent of county employment",
    color = NULL,
    caption = my_caption
  )
  
```

<br>

The same information is presented below with simple ranking:

```{r fig.height=8, fig.width=10}
#| label: fig-rank-employee-count-top-counties-rank
#| fig-height: 8
#| fig-width: 10
#| fig-cap: "Sector rank by number of employees"
#| fig-alt: "Like the prior plot, this plot shows the top 5 sectors for the 10 largest counties by employment in North Carolina, from the largest (Mecklenburg) to the tenth-largest (Catawba). Lines connect the same industry sector in adaject columns. The difference is that Y axis is a simple ranking 1 to 5 of percent county employment."

data_for_plot |>
  ggplot() +
  geom_line(aes(x = county_name_label, y = emp_rank, group = naics_abbr, color = naics_abbr),
            show.legend = FALSE, na.rm = TRUE) +
  geom_label(aes(x = county_name_label, y = emp_rank, label = naics_abbr, fill = naics_abbr),
             show.legend = FALSE, na.rm = TRUE, alpha = 0.4, size = data_label_size) +
  scale_x_discrete(position = "top") +
  scale_y_reverse() +
  theme(axis.text.x = element_text(size = 10)) +
  labs(
    title = "Top 5 sectors in 10 largest NC counties: ranking",
    subtitle = glue("Ordered by total county employment reported in CBP",
                    "; 'Statewide' refers to workers not associated with one county"),
    x = "",
    y = "Rank in county employment",
    color = NULL,
    caption = my_caption
  )
  
```

<br>

## Trends in employment

The last two decades have brought significant changes in the number and mix of employees in NC. The financial crisis in 2008 and the following years caused significant job losses (and company closings see @fig-state-establishments-naics-timeseries), the trend overall has been upward, reflecting the growing population of the state.

```{r fig.height=6, fig.width=12}
#| label: fig-state-employment-total-timeseries
#| fig-height: 6
#| fig-width: 12
#| fig-cap: "NC workers 2001-2021"
#| column: page-inset-right
#| warning: false
#| fig-alt: "This line plot shows the number of employees in each sector from 2001 to 2021. A second plot shows the percent change year to year over the same time period."

state_emp_change <- d_emp_total_state_nc |>
  mutate(emp_fist_year = emp[year == min(year)],
         emp_last_year = emp[year == max(year)],
         .by = c("naics")) |>
  mutate(pct_emp_diff = emp_last_year / emp_fist_year - 1) |>
  distinct(emp_fist_year, emp_last_year, pct_emp_diff)

data_for_plot <- d_emp_total_state_nc |>
  arrange(year) |>
  mutate(pct_emp_diff_yty = emp / lag(emp) - 1)
  
p1 <- data_for_plot |>
  ggplot() +
  geom_line(aes(x = year, y = emp, color = year),
           linewidth = 1, alpha = 0.6, show.legend = FALSE) +
  scale_y_continuous(labels = label_number(scale_cut = cut_short_scale())) +
  guides(color = guide_legend(override.aes = c(linewidth = 3))) +
   expand_limits(y = 0) +
  labs(
    subtitle = "NC workers",
    x = "",
    y = "Number of employees",
    color = NULL,
    caption = my_caption
  )

p2 <- data_for_plot |>
  ggplot(aes(year, pct_emp_diff_yty, color = year)) + #, color = year
  geom_hline(yintercept = 0, lty = 2, linewidth = 0.2, alpha = 0.2) +
  geom_line(linewidth = 1, alpha = 0.6, na.rm = TRUE, show.legend = FALSE) +
  scale_y_continuous(labels = label_percent()) +
  labs(
    subtitle = glue("Change in percent employment year-to-year"),
    x = "Employees in NC in 2021",
    y = "Pct change yty"
    )

(p1 + p2) +
  plot_annotation(
    title = "NC workers 2001-2021",
    subtitle = glue("By 2021 employment was up {percent(state_emp_change$pct_emp_diff, accuracy = 0.1)}",
                    " after more than losing all gains from the first decade in the aftermath of the 2008 financial crisis.",
                    "\nIncludes all sectors reported in CBP"),
    caption = my_caption
  )

```

<br>

The sector-level dynamics have varied a lot. Compare Manuf with HealthSoc, for example:

```{r fig.height=10, fig.width=12}
#| label: fig-state-employment-naics-timeseries
#| fig-height: 10
#| fig-width: 12
#| fig-cap: "NC workers in each sector 2001-2021"
#| column: page-inset-right
#| warning: false
#| fig-alt: "This line plot shows the number of employees in each sector from 2001 to 2021. A second plot shows the same data as a stacked area plot. A third plot below the others shows the percent change since 2021 on the Y axis and number of employees in 2021 on the X axis."

data_for_plot <- d_emp_sector_total_state_nc |>
  filter(naics_abbr != "OtherInd") |>
  mutate(naics_abbr = fct_reorder(naics_abbr, -emp)
         ) |>
  mutate(emp_fist_year = emp[year == min(year)],
         emp_last_year = emp[year == max(year)],
         .by = c("naics")) |>
  mutate(pct_emp_diff = emp_last_year / emp_fist_year - 1)

labels_for_plot <- data_for_plot |>
  filter(year == max(year))

p1 <- data_for_plot |>
  filter(naics_abbr != "Other") |>
  ggplot() +
  geom_line(aes(x = year, y = emp, color = naics_abbr, group = naics_abbr),
           linewidth = 0.4, alpha = 0.6, show.legend = FALSE) +
  geom_text_repel(data = labels_for_plot,
                  aes(x = year + 0.5, y = emp, label = naics_abbr, color = naics_abbr),
                  direction = "y", hjust = 0, vjust = 0.5, size = 3,
                  min.segment.length = unit(1, "cm"), force_pull = 100,
                  seed = 123,
                  show.legend = FALSE) +
  scale_y_continuous(labels = label_number(scale_cut = cut_short_scale())) +
  expand_limits(x = 2026,
                y = 0) +
  guides(color = guide_legend(override.aes = c(linewidth = 3))) +
  labs(
    subtitle = "NC workers in each sector",
    x = "",
    y = "Number of employees",
    color = NULL,
    caption = my_caption
  )

p2 <- data_for_plot |>
  filter(naics_abbr != "Other") |>
  ggplot() +
  geom_area(aes(x = year, y = emp, color = naics_abbr, fill = naics_abbr, group = naics_abbr),
           linewidth = 0.4, alpha = 0.6, show.legend = FALSE) +
  scale_y_continuous(labels = label_number(scale_cut = cut_short_scale()),
                     expand = expansion(mult = c(0, 0.02))) +
  expand_limits(y = 0) +
  guides(color = guide_legend(override.aes = c(linewidth = 3))) +
  labs(
    subtitle = "NC workers combined trend",
    x = "",
    y = "Number of employees",
    color = NULL,
    caption = my_caption
  )

p3 <- data_for_plot |>
  filter(year == 2021,
         emp != 0) |>
  ggplot(aes(emp, pct_emp_diff, color = naics_abbr)) +
  geom_hline(yintercept = 0, lty = 2, size = 0.2, alpha = 0.2) +
  geom_label(aes(label = naics_abbr),
             show.legend = FALSE, hjust = 0.5, vjust = 0.5) +
  scale_x_continuous(labels = label_number(scale_cut = cut_short_scale())) +
  scale_y_continuous(labels = label_percent()) +
  labs(
    subtitle = glue("What is the percent change in employment since 2001?"),
    x = "Employees in NC in 2021",
    y = "Pct change since 2001"
    )

(p1 + p2) / p3 +
  plot_annotation(
    title = "NC workers in each employee sector 2001-2021",
    subtitle = "Includes all sectors reported in CBP",
    caption = my_caption
  )

```

<br>

The portion of employees in each employee class size varies over time and across sectors. Decade-long trends are visible: 

* The share of employees in the Accommodation and Food sector has been increasing in most employee size classes, yet this sector suffered the most during the COVID-19 pandemic 2020-2021.
* The share in Manufacturing has been in noticeable decline, especially through 2015 and in the larger employee size classes
* Construction slowed significantly after the 2008 financial crisis.

In the HealthSoc, Retail, and ProfSciTec sectors there are cases of big changes from one year to the next in multiple employee size classes. I wonder if this is due to changes in NAICS categories, changes in measurement methodology, or a real change in that sector.

Noise added to some data before release may be the cause of the jumpiness in some of the least common employee size classes.

```{r fig.height=8, fig.width=10}
#| label: fig-state-employees-naics-pct-timeseries-top-9-sectors
#| fig-height: 8
#| fig-width: 10
#| fig-cap: "Percent of NC workers in each employee size class by sector"
#| column: page-inset-right
#| fig-alt: "This nine-panel line plot shows employee size class from 2001 to 2021 for the nine industry sectors employing the most poeple."

data_for_plot <- d_emp_state_nc_size_classes |>
  inner_join(n_employees_ref |>
               select(-est_size_class),
             by = "emp_size_class") |>
  mutate(emp_size_class = factor(emp_size_class, levels = emp_size_class_levels),
         naics_abbr = fct_lump(naics_abbr, n = 9, w = emp)) 

data_for_plot |>
  filter(naics_abbr != "Other") |>
  ggplot() +
  geom_line(aes(x = year, y = pct_emp, color = emp_size_class, group = emp_size_class),
           linewidth = 0.4, alpha = 0.6) +
  scale_y_continuous(labels = label_percent(accuracy = 0.1)) +
  facet_wrap(. ~ naics_abbr, scales = "free_y") +
  guides(color = guide_legend(override.aes = c(linewidth = 3))) +
  labs(
    title = "Percent of NC workers in each employee size class\nby sector 2001-2021",
    subtitle = "Top 9 sectors by number of employees (in 2021) as reported in CBP",
    x = "",
    y = "Percent of employees (scale varies)",
    color = NULL,
    caption = my_caption
  )

```

<br>

The year over year drop in manufacturing jobs through 2012 is striking. As is the consistent growth through the 21-year period in (1) Healthcare and social services and (2) Accommodation and food.

```{r fig.height=5, fig.width=7}
#| label: fig-rank-employment
#| fig-height: 5
#| fig-width: 7
#| fig-cap: "Employment trend: top 5 sectors by number of employees"
#| fig-alt: "This line plot shows the number of employees in each sector from 2001 to 2021."

data_for_plot <- d_emp_sector_total_state_nc |>
  inner_join(top_naics,
             by = c("naics", "naics_abbr")) |>
  mutate(naics_abbr = fct_reorder(naics_abbr, emp))

data_for_plot |>
  ggplot(aes(year, emp, color  = naics_abbr)) +
  geom_point(size = 0.6, alpha = 0.4,
            show.legend = FALSE) +
  geom_labelsmooth(aes(label = naics_abbr,
                       hjust = naics_sort_order / top_naics_cutoff - 0.1),
                   method = 'loess', formula = 'y ~ x', span = 0.95,
                   show.legend = FALSE) +
  scale_y_continuous(labels = label_number(scale_cut = cut_short_scale()),
                     expand = expansion(mult = c(0, 0.02))) +
  scale_x_continuous(breaks = c(2001, 2011, 2021)) +
  expand_limits(y = 0) +
  guides(color = guide_legend(reverse = TRUE)) +
  labs(
    title = glue("NC employment trend:\nTop {top_naics_cutoff} sectors"),
    x = "",
    y = "Number of employees",
    color = "",
    caption = my_caption
  )
  
```

<br>

## Trends in employment - counties

There is naturally more variation when looking at the 100 counties rather than state summaries. The patterns are generally the same across counties of differing number of workers. I see two noticeable differences: (1) the largest counties are not in the group of the most extreme growth or decline; and (2) there is a group of ten or so mid-sized counties that declined modestly from 2001-2007, then quickly 2008-2009, and have grown slowly since then but still with lower employment than in 2001.

```{r fig.height=8, fig.width=14}
#| label: fig-county-employees-sector-totals-time-series-pct
#| fig-height: 8
#| fig-width: 14
#| fig-cap: "NC state employees by county (percent) 2021-2021"
#| column: page-inset-right
#| fig-alt: "This line plot shows the growth of each NC county from 2001 to 2021 plus the same information grouped into three groups by the number of workers in the county."

data_for_plot <- d_emp_total_county |>
  filter(county_name != "Statewide, NC") |>
  arrange(year) |>
  mutate(pct_growth_since_2001 = emp / emp[year == min(year)],
         pct_growth_full_period = pct_growth_since_2001[year == max(year)],
         pct_emp_diff_yty = emp / lag(emp) - 1,
         .by = c(fipscty)) |>
  mutate(size_group = case_when(
    emp < 1e4                ~ "group 1: small\nemp < 10K",
    emp < 1e5                ~ "group 2: medium\n10K < emp < 100K",
    emp >= 1e5               ~ "group 3: large\nemp > 100K"
  ))

labels_for_plot_tmp <- data_for_plot |>
  filter(year == max(year)) 

labels_for_plot <- bind_rows(
  labels_for_plot_tmp |>
    slice_max(order_by = pct_growth_full_period, n = 5),
  labels_for_plot_tmp |>
    slice_min(order_by = pct_growth_full_period, n = 5)
)

n_smaller <- data_for_plot |>
  filter(year == max(year)) |>
  filter(pct_growth_full_period < 1) |>
  nrow()

p1 <- data_for_plot |>
  ggplot() +
  geom_hline(yintercept = 1, lty = 2, size = 0.2, alpha = 0.2) +
  geom_line(aes(x = year, y = pct_growth_since_2001, group = county_name, color = pct_growth_full_period),
            linewidth = 0.4, alpha = 0.6, show.legend = FALSE) +
  geom_text_repel(data = labels_for_plot,
                  aes(x = year + 0.5, y = pct_growth_full_period, label = county_name),
                  direction = "y", hjust = 0, vjust = 0.5, size = 3,
                  min.segment.length = unit(1, "cm"), force_pull = 100,
                  seed = 123,
                  show.legend = FALSE) +
  scale_color_viridis_c(end = 0.85) +
  expand_limits(x = 2027) +
  labs(
    subtitle = "County growth trajectories - all counties",
    x = NULL,
    y = "Growth (2001 = 1)"
  )

p2 <- data_for_plot |>
  ggplot() +
  geom_hline(yintercept = 1, lty = 2, size = 0.2, alpha = 0.2) +
  geom_line(aes(x = year, y = pct_growth_since_2001, group = county_name, color = pct_growth_full_period),
            linewidth = 0.4, alpha = 0.6, show.legend = FALSE) +
  geom_text_repel(data = labels_for_plot,
                  aes(x = year + 0.5, y = pct_growth_full_period, label = county_name),
                  direction = "y", hjust = 0, vjust = 0.5, size = 3,
                  min.segment.length = unit(1, "cm"), force_pull = 100,
                  seed = 123,
                  show.legend = FALSE) +
  scale_color_viridis_c(end = 0.85) +
  facet_wrap( ~ size_group) +
  expand_limits(x = 2027) +
  labs(
    subtitle = "County growth trajectories - grouped by number of workers in the county",
    x = NULL,
    y = "Growth (2001 = 1)"
  )

p1 + p2 +
    plot_layout(widths = c(1, 3)) +
    plot_annotation(
      title = "County employee growth trajectories 2001-2021",
      subtitle = glue("{n_smaller} of 100 counties ended the period with fewer workers", 
                      "; as reported in CBP; excludes 'Statewide'",
                      "; with names of counties with most growth and decline"),
      caption = my_caption
    )
  
```

<br>

Placing the county trends in their approximate geographic context, it's noticeable that (1) growth or decline is not concentrated in one part of the state; (2) most of the workers are in a relatively small number of counties; and (3) most of the counties with more than 50K workers saw employment growth 2001-2021 (and plenty of counties with few workers saw employment growth too).

```{r fig.height=10, fig.width=24}
#| label: fig-emp-geofacet-pct-counts
#| fig-cap: "Employment trends in NC counties (approximate geographical position)"
#| fig-height: 10
#| fig-width: 24
#| column: screen-inset-right
#| fig-alt: "This plot shows the number of workers in each NC county in the years 2001-2021. It offers a facet for each NC county placed in the approximate geographical location of the county."

data_for_plot <- d_emp_total_county |>
  filter(county_name != "Statewide, NC") |>
  mutate(pct_growth_since_2001 = emp / emp[year == min(year)],
         pct_growth_full_period = pct_growth_since_2001[year == max(year)],
         .by = c(fipscty)) |>
  mutate(county_name = if_else(county_name == "McDowell", "Mcdowell", county_name),
         fill_color = if_else(pct_growth_full_period > 1, "up", "down"))

data_for_plot |>
  ggplot() +
  geom_rect(aes(xmin = min(year) - 1, xmax = max(year) + 1, 
                ymin = min(emp) - 0.05 * min(emp), ymax = max(emp) + 0.05 * max(emp),
                fill = fill_color),
            alpha = 0.01, show.legend = FALSE) +
  geom_line(aes(x = year, y = emp), 
            show.legend = FALSE) +
  scale_x_continuous(breaks = c(2001, 2011, 2021),
                     expand = expansion(mult = c(0,0))) +
  scale_y_continuous(breaks = c(0, 2e5, 4e5, 6e5),
                     labels = label_number(scale_cut = cut_short_scale()),
                     expand = expansion(mult = c(0.02,0))) +
  scale_fill_viridis_d(end = 0.85) +
  facet_geo( ~ county_name,
             grid = "us_nc_counties_grid1") +
  theme(panel.grid = element_blank(),
        axis.title.y = element_text(hjust = 1),
        axis.text.x = element_text(angle = 60, hjust = 1),
        plot.title = element_text(size = rel(3.0), face = "bold"),
        legend.position = "top") +
  labs(title = "Employment in NC counties 2001-2021", 
       subtitle = glue("Green cells indicate higher employment at end of period"),
       x = NULL,
       y = "Number of workers",
       caption = my_caption)

```

<br>

Looking at change year-to-year for each county where 2001 employment equals 1, some patterns emerge: (1) counties with employment growth in this period tended to grow fast, declined during and after the financial crisis, then grew beyond their previous high water mark in the last decade; (2) some counties in decline lost workers nearly every year.

```{r fig.height=10, fig.width=24}
#| label: fig-emp-geofacet-pct-yty
#| fig-cap: "Employment trends in NC counties (approximate geographical position)"
#| fig-height: 10
#| fig-width: 24
#| column: screen-inset-right
#| fig-alt: "This plot shows the year-to-year growth in the number of workers in each NC county in the years 2001-2021. It offers a facet for each NC county placed in the approximate geographical location of the county."

data_for_plot <- d_emp_total_county |>
  filter(county_name != "Statewide, NC") |>
  mutate(pct_growth_since_2001 = emp / emp[year == min(year)],
         pct_growth_full_period = pct_growth_since_2001[year == max(year)],
         .by = c(fipscty)) |>
  mutate(county_name = if_else(county_name == "McDowell", "Mcdowell", county_name),
         fill_color = if_else(pct_growth_full_period > 1, "up", "down"))

data_for_plot |>
  ggplot() +
  geom_rect(aes(xmin = min(year) - 1, xmax = max(year) + 1, 
                ymin = min(pct_growth_since_2001) - 0.05, ymax = max(pct_growth_since_2001) + 0.05,
                fill = fill_color),
            alpha = 0.01, show.legend = FALSE) +
  geom_hline(yintercept = 1, lty = 2, size = 0.2, alpha = 0.3) +
  geom_line(aes(x = year, y = pct_growth_since_2001), 
            show.legend = FALSE) +
  scale_x_continuous(breaks = c(2001, 2011, 2021),
                     expand = expansion(mult = c(0,0))) +
  scale_y_continuous(labels = label_number(scale_cut = cut_short_scale()),
                     expand = expansion(mult = c(0,0))) +
  scale_fill_viridis_d(end = 0.85) +
  facet_geo( ~ county_name,
             grid = "us_nc_counties_grid1") +
  theme(panel.grid = element_blank(),
        axis.title.y = element_text(hjust = 1),
        axis.text.x = element_text(angle = 60, hjust = 1),
        plot.title = element_text(size = rel(3.0), face = "bold"),
        legend.position = "top") +
  labs(title = "Year-to-year change in employment in NC counties 2001-2021", 
       subtitle = glue("2001 = 1; green cells indicate higher employment at end of period"),
       x = NULL,
       y = "Change in employment",
       caption = my_caption)

```

<br>

There is variation in the industry sectors, counties, and employee size classes.

```{r fig.height=12, fig.width=10}
#| label: fig-county-naics-employees-size-class-time-series-pct
#| fig-height: 12
#| fig-width: 10
#| fig-cap: "NC state employees by establishment size class and sector (percent) 2001-2021"
#| column: page-inset-right
#| fig-alt: "This 80 panel plot shows percent of workers in each employee size class from 2001 to 2021. Each column of panels is an industry sector. Each row of panels is a county."    

data_for_plot <- d_emp_county_nc_size_classes |>
  mutate(naics_abbr = fct_lump(naics_abbr, n = 8, w = pct_emp),
         county_name = fct_lump(county_name, n = 10, w = emp),
         county_name = fct_rev(county_name)) 

data_for_plot |>
  filter(naics_abbr != "Other",
         county_name != "Other") |>
  ggplot() +
  geom_line(aes(x = year, y = pct_emp, color = emp_size_class, group = emp_size_class),
           linewidth = 0.4, alpha = 0.6) +
  scale_x_continuous(breaks = c(2001, 2011, 2021)) +
  scale_y_continuous(labels = label_percent(accuracy = 0.1)) +
  facet_grid(county_name ~ naics_abbr, scales = "free_y") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5)) +
  guides(color = guide_legend(override.aes = c(linewidth = 3))) +
  labs(
    title = "Percent of workers in each employee size class\nby sector and county 2001-2021",
    subtitle = "Top 8 sectors in largest 10 largest counties by employment (in 2021) as reported in CBP",
    x = "",
    y = "Percent of employees (scale varies by row)",
    color = NULL,
    caption = my_caption
  )
  
```

<br>

## Trends in average wages statewide

Average wage trends are not uniform across sectors. Wages in four of the five highest paying sectors grew faster than inflation while they dropped in "Management". I wonder if the drop in the average wage of the management sector is due to manufacturing and financial services disruptions set in motion by the 2008 financial crisis and the COVID-19 pandemic. Or perhaps managers are getting a smaller portion of their income in wages and more in stock or other benefits.

```{r fig.height=5, fig.width=7}
#| label: fig-rank-employee-wages-top-sectors-2021-dollars
#| fig-height: 5
#| fig-width: 7
#| fig-cap: "Wage trend: top 5 sectors by average wage in 2021"
#| fig-alt: "This line plot shows the trend in average wages from 2001 to 2021."

top_wage <- d_emp_sector_total_state_nc |>
  filter(year == 2021) |>
  slice_max(order_by = avg_wage, n = top_naics_cutoff) |>
  mutate(wage_sort_order = row_number()) |>
  select(naics, wage_sort_order)

data_for_plot <- d_emp_sector_total_state_nc |>
  inner_join(top_wage,
             by = "naics") |>
  inner_join(d_infation_adj,
             by = "year") |>
  mutate(avg_wage_adjusted = avg_wage * adj)

data_for_plot |>
  ggplot(aes(year, avg_wage_adjusted, color  = naics_abbr, group = naics_abbr)) +
  geom_point(size = 0.6, alpha = 0.4,
            show.legend = FALSE) +
  geom_labelsmooth(aes(label = naics_abbr, 
                       hjust = wage_sort_order / top_naics_cutoff - 0.1),
                   method = 'loess', formula = 'y ~ x', span = 0.95,
                   show.legend = FALSE) +
  scale_y_continuous(labels = label_number(scale_cut = cut_short_scale(),
                                           prefix = "$"),
                     expand = expansion(mult = c(0, 0.02))) +
  scale_x_continuous(breaks = c(2001, 2011, 2021)) +
  guides(color = guide_legend(reverse = TRUE)) +
  expand_limits(y = 0) +
  labs(
    title = glue("NC average wage trend:\nTop {top_naics_cutoff} sectors"),
    subtitle = glue("In 2021 dollars"),
    x = "",
    y = "",
    color = "",
    caption = my_caption
  )

```

<br>

```{r fig.height=8, fig.width=10}
#| label: fig-wage-trend-top-sectors
#| fig-height: 10
#| fig-width: 8
#| fig-cap: "NC average wage trend by sector 2001-2021"
#| warning: false
#| fig-alt: "The first two line plot shows the trend in average wages by sector from 2001 to 2021. On the left are the two sectors where wages have declined; on the right are all the others. A third plot below the others shows the percent change in average wages since 2021 on the Y axis and number of employees in 2021 on the X axis."

data_for_plot <- d_emp_sector_total_state_nc |>
  inner_join(d_infation_adj,
             by = "year") |>
  mutate(avg_wage_adjusted = avg_wage * adj) |>
  mutate(wage_fist_year = avg_wage_adjusted[year == min(year)],
         wage_last_year = avg_wage_adjusted[year == max(year)],
         .by = c("naics")) |>
  mutate(wage_diff = wage_last_year - wage_fist_year,
         wage_direction = if_else(wage_diff > 0, "wage up", "wage down"),
         pct_wage_diff = wage_last_year / wage_fist_year - 1)

labels_for_plot <- data_for_plot |>
  filter(year == max(year))
  
p1 <- data_for_plot |>
  filter(emp != 0) |>
  ggplot(aes(year, avg_wage_adjusted, color = naics_abbr)) +
  geom_point(size = 1, alpha = 0.2, na.rm = TRUE,
             show.legend = FALSE) +
  geom_smooth(method = 'loess', formula = 'y ~ x',
              #span = 3,
              se = FALSE, show.legend = FALSE) +
  geom_text_repel(data = labels_for_plot,
                  aes(x = year + 0.5, y = avg_wage_adjusted, label = naics_abbr),
                  direction = "y", hjust = 0, vjust = 0.5, size = 3,
                  min.segment.length = unit(1, "cm"), force_pull = 100,
                  seed = 123,
                  show.legend = FALSE) +
  scale_y_continuous(labels = label_number(scale_cut = cut_short_scale(),
                                           prefix = "$"),
                     expand = expansion(mult = c(0, 0.02))) +
  expand_limits(x = 2026,
                y = 0) +
  facet_wrap(~ wage_direction) +
  labs(
    subtitle = "NC average wage trend in 2021 up or down compared to 2001",
    x = NULL,
    y = "Average wages"
  )

p2 <- data_for_plot |>
  filter(year == 2021,
         emp != 0) |>
  ggplot(aes(emp, pct_wage_diff, color = naics_abbr)) +
  geom_hline(yintercept = 0, lty = 2, size = 0.2, alpha = 0.2) +
  geom_label(aes(label = naics_abbr),
             show.legend = FALSE, hjust = 0.5, vjust = 0.5) +
  scale_x_continuous(labels = label_number(scale_cut = cut_short_scale())) +
  scale_y_continuous(labels = label_percent()) +
  labs(
    subtitle = glue("Percent change in average wages since 2001"),
    x = "Employees in NC in 2021",
    y = "Percent change in average wage since 2001"
    )

p1 / p2 +
  plot_annotation(
    title = "Average wages by sector 2001-2021",
    subtitle = "In 2021 dollars; includes all sectors reported in CBP",
    caption = my_caption
  )

```

<br>

There is a lot of wage variation in subcategories based on job role and location. Consider "Health and social services" (HealthSoc):

```{r fig.height=6, fig.width=10}
#| label: fig-wage-healthsoc
#| fig-height: 6
#| fig-width: 10
#| fig-cap: "NC average wages in HealthSoc sector"
#| warning: false
#| column: page-inset-right
#| fig-alt: "The first plot shows the 20 most common detailed NAICS categories in the 'Health and Social Services' category in NC counties. Violin plots show the distribution of average wages over the years 2001-2021. The second plot shows a line for each detailed NAICS category with number of employees in the county on the X axis and average wage on the Y axis. It's clear that in general, employees in counties with more workers in that category enjoy higher wages."

data_for_plot <- d_emp_county_healthsoc |>
  filter(emp >= 10,
         !str_detect(naics, "/$|-$")) |> # only the most detailed categories
  mutate(naics_descr = fct_lump(naics_descr, 20)) |>
  filter(naics_descr != "Other") |>
  inner_join(d_infation_adj,
             by = "year") |>
  mutate(avg_wage_adjusted = avg_wage * adj) |>
  filter(!is.na(avg_wage_adjusted))

ave_wage_detailed_naics <- data_for_plot |>
  summarize(avg_wage = weighted.mean(avg_wage_adjusted, w = emp),
         .by = c(naics, naics_descr))

n_datapoints <- nrow(data_for_plot)
  
p1 <- data_for_plot |>
  mutate(naics_descr = fct_reorder(naics_descr, avg_wage, mean)) |>
  ggplot(aes(avg_wage, naics_descr, fill = naics_descr)) +
  geom_violin(linewidth = 0.2, alpha = 0.7, show.legend = FALSE) + #fill = carolina_blue, 
  geom_point(data = ave_wage_detailed_naics,
             aes(avg_wage, naics_descr),
             shape = "|", size = 4, show.legend = FALSE) +
  scale_x_continuous(labels = label_number(scale_cut = cut_short_scale(),
                                           prefix = "$"),
                     expand = expansion(mult = c(0, 0.02))) +
  labs(
    subtitle = glue("Average wage in HealthSoc varies widely"),
    x = "Distribution of avg wages\nvertical bar at mean",
    y = NULL,
  )

p2 <- data_for_plot |>
  mutate(naics_descr = fct_reorder(naics_descr, avg_wage, mean)) |>
  ggplot(aes(emp, avg_wage, group = naics_descr, color = naics_descr)) +
  geom_smooth(span = 0.97, method = 'loess', formula = 'y ~ x',
              se = FALSE, show.legend = FALSE,
              linewidth = 0.6, alpha = 0.4) +
  scale_x_log10(labels = label_number(scale_cut = cut_short_scale())) +
  scale_y_continuous(labels = label_number(scale_cut = cut_short_scale(),
                                           prefix = "$")) +
  labs(
    subtitle = glue("Average wages generally are higher\nin counties with more workers"),
    x = "Employees (log10 scale)",
    y = "Avg sector wage",
    y = NULL
    )

p1 + p2 +
  plot_annotation(
    title = "HealthSoc in NC 2001-2021",
    subtitle = glue("In 2021 dollars; includes data where [year, county, naics] employee count ≥ 10 in at least 20 of the 100 NC counties", 
                    "\nMost detailed NAICS categories only; N = {comma(n_datapoints)}"),
    caption = my_caption
  )

```

<br>

## Tables {#sec-tables}

Below are the sector summary categories used in the CBP. To simplify plotting, I created some abbreviations:

```{r}
#| label: tbl-sector-abbreviations
#| tbl-cap: "NAICS sector categories and abbreviations"
#| tbl-cap-location: bottom

d_naics_abbr_ref |>
  arrange(naics_abbr_num) |>
  select(naics_abbr, naics_descr) |>
  mutate(rowid = row_number()) |>
  gt() |>
  tab_header(md(glue("**NAICS categories and abbreviations used in this analysis**"))) |>
  tab_source_note(md("*US Census County Business Patterns; analysis by Daniel Moul*")) |>
  tab_options(table.font.size = 10)
  
```

<br>

Sectors sorted by number of employees:

```{r}
#| label: tbl-state-nc-emp
#| tbl-cap: "NC state employment by sector 2021"
#| tbl-cap-location: bottom

d_emp_sector_total_state_nc |>
  filter(year == 2021) |>
  filter(naics_abbr != "OtherInd") |>
  select(naics, naics_abbr, naics_descr, emp_2021 = emp, pct_emp_2021 = pct_emp) |>
  arrange(-emp_2021) |>
  mutate(rowid = row_number()) |>
  relocate(naics_descr, .after = naics) |>
  gt() |>
  tab_header(md(glue("**NC sector employment 2021**",
                     "<br>*Sorted by sector employment*"))) |>
  tab_source_note(md("*US Census County Business Patterns; analysis by Daniel Moul*")) |>
  tab_options(table.font.size = 10) |>
  fmt_number(columns = c(emp_2021), #, avg_wage
             decimals = 0) |>
  fmt_percent(columns = pct_emp_2021, 
             decimals = 0)

```

<br>

Sorted by percent difference from 2001 to 2021

```{r}
#| label: tbl-state-nc-emp-growth
#| tbl-cap: "NC state employment growth by sector 2001-2021"
#| tbl-cap-location: bottom

d_emp_sector_total_state_nc |>
  filter(naics_abbr != "OtherInd") |>
  mutate(naics_abbr = fct_reorder(naics_abbr, -emp)
         ) |>
  mutate(emp_fist_year = emp[year == min(year)],
         emp_last_year = emp[year == max(year)],
         .by = c("naics")) |>
  mutate(pct_emp_diff = emp_last_year / emp_fist_year - 1) |>
  filter(year == 2021) |>
  select(naics, naics_abbr, emp_2021 = emp, pct_emp_2021 = pct_emp, pct_emp_diff_since_2001 = pct_emp_diff) |>
  arrange(-pct_emp_diff_since_2001) |>
  mutate(rowid = row_number()) |>
  gt() |>
  tab_header(md(glue("**NC sector employment in 2021 and growth since 2001**",
                     "<br>*Sorted by growth since 2001*"))) |>
  tab_source_note(md("*US Census County Business Patterns; analysis by Daniel Moul*")) |>
  tab_options(table.font.size = 10) |>
  fmt_number(columns = c(emp_2021),
             decimals = 0) |>
  fmt_percent(columns = c(pct_emp_2021, pct_emp_diff_since_2001),
             decimals = 0)

```

Sorted by average wage:

```{r}
#| label: tbl-state-nc-emp-wage
#| tbl-cap: "NC state average wage by sector 2021"
#| tbl-cap-location: bottom

d_emp_sector_total_state_nc |>
  filter(year == 2021) |>
  select(naics, naics_abbr, avg_wage_2021 = avg_wage, emp_2021 = emp, pct_emp_2021 = pct_emp) |>
  arrange(-avg_wage_2021) |>
  mutate(rowid = row_number()) |>
  gt() |>
  tab_header(md(glue("**NC sector employment 2021**",
                     "<br>*Sorted by sector average wage*"))) |>
  tab_source_note(md("*US Census County Business Patterns; analysis by Daniel Moul*")) |>
  tab_options(table.font.size = 10) |>
  fmt_number(columns = c(emp_2021, avg_wage_2021),
             decimals = 0) |>
  fmt_percent(columns = pct_emp_2021, 
             decimals = 0)

```

<br>

```{r}
#| label: tbl-state-nc-emp-wage-growth
#| tbl-cap: "NC state average wage growth by sector 2001-2021"
#| tbl-cap-location: bottom

d_emp_sector_total_state_nc |>
  inner_join(d_infation_adj,
             by = "year") |>
  mutate(avg_wage_adjusted = avg_wage * adj) |>
  mutate(wage_fist_year = avg_wage_adjusted[year == min(year)],
         wage_last_year = avg_wage_adjusted[year == max(year)],
         .by = c("naics")) |>
  mutate(wage_diff = wage_last_year - wage_fist_year,
         pct_wage_diff = wage_last_year / wage_fist_year - 1) |>
  filter(year == 2021) |>
  select(naics, naics_abbr, avg_wage_2021 = wage_last_year, pct_avg_wage_diff_since_2001 = pct_wage_diff, 
         emp_2021 = emp, pct_emp_2021 = pct_emp) |>
  arrange(-pct_avg_wage_diff_since_2001) |>
  mutate(rowid = row_number()) |>
  gt() |>
  tab_header(md(glue("**NC sector average wage 2021 and difference since 2001**",
                     "<br>*Sorted by average wage difference*"))) |>
  tab_source_note(md("*US Census County Business Patterns; analysis by Daniel Moul*")) |>
  tab_options(table.font.size = 10) |>
  fmt_number(columns = c(avg_wage_2021, emp_2021),
             decimals = 0) |>
  fmt_percent(columns = c(pct_avg_wage_diff_since_2001, pct_emp_2021), 
             decimals = 0)

```

<br>

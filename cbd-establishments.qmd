# NC establishments 2001-2021

```{r}
#| include: false

source("./scripts/setup.R")

data_label_size <- 3.5 # for plots using labels as data points

```

```{r}
# since no change in NC county FIPS codes over this time period, I can use the latest
# includes fipscty 999 "Statewide" that corresponds to employment not associated with a county
d_fips_county_ref <- read_csv("./data/ref/georef17.txt",
                      col_types = "ccc",
                      show_col_types = FALSE) |>
  rename(fipstate = st,
         fipscty = cty,
         county_name = ctyname) |>
  filter(fipstate == "37") |>
  mutate(county_name = str_remove(county_name, " County, North Carolina$"),
         county_name = if_else(county_name == "Statewide, North Carolina", "Statewide, NC", county_name))

d_fips_state_ref <- read_csv("./data/ref/georef17.txt",
                      col_types = "ccc",
                      show_col_types = FALSE) |>
  distinct(st, .keep_all = TRUE) |>
  mutate(state_name = str_extract(ctyname, "(?<=, ).*$")) |>
  select(fipstate = st,
         state_name)

# Since sector total codes and descriptions have not changed in this time period, I'll use the latest
# TODO: confirm this assumption!!
d_naics_ref_2021 <- read_csv("./data/ref/naics2017.txt",
                      col_types = "cc",
                      show_col_types = FALSE) |>
  clean_names()|>
  mutate_if(is.character, ~ purrr::map_chr(.x, iconv, "UTF-8", "UTF-8", sub='')) %>% # just in case
  rename(naics_descr = description) |>
  mutate(naics_descr = str_to_sentence(naics_descr),
         naics_descr = str_replace_all(naics_descr, "&", "and"))

d_naics_abbr_ref <- tribble(
  ~ naics_descr,                                                                 ~naics_abbr_num,  ~naics_abbr,
   "Agriculture, Forestry, Fishing and Hunting",                                  3,               "AgForFish",
   "Utilities",                                                                   17,              "Util",
   "Construction",                                                                5,               "Constr",
   "Manufacturing",                                                               10,              "Manuf",
   "Wholesale Trade",                                                             18,              "Whlsale",
   "Retail Trade",                                                                15,              "Retail",
   "Transportation and Warehousing",                                              16,              "Transpt",
   "Information",                                                                 9,               "Info",
   "Finance and Insurance",                                                       7,               "FinIns",
   "Real Estate and Rental and Leasing",                                          14,              "RealEst",
   "Professional, Scientific, and Technical Services",                            13,              "ProfSciTec",
   "Management of Companies and Enterprises",                                     12,              "Mgmt",
   "Administrative and Support and Waste Management and Remediation Services",    2,               "AdminWaste",
   "Educational Services",                                                        6,               "Educ",
   "Health Care and Social Assistance",                                           8,               "HeathSoc",
   "Arts, Entertainment, and Recreation",                                         4,               "ArtEntRec",
   "Accommodation and Food Services",                                             1,               "AccFood",
   "Other Services (except Public Administration)",                               19,              "OtherServ",
   "Industries not classified",                                                   20,              "OtherInd",
   "Mining, Quarrying, and Oil and Gas Extraction",                               11,              "MineOilGas"
) |>
  mutate(naics_descr = str_to_sentence(naics_descr))

d_naics_ref_2021 <- read_csv("./data/ref/naics2017.txt",
                      col_types = "cc",
                      show_col_types = FALSE) |>
  clean_names()|>
  mutate_if(is.character, ~ purrr::map_chr(.x, iconv, "UTF-8", "UTF-8", sub='')) %>% # just in case
  rename(naics_descr = description) |>
  mutate(naics_descr = str_to_sentence(naics_descr),
         naics_descr = str_replace_all(naics_descr, "&", "and"))


# assume processed data files exist (that cbd-employment-wages.qmd has been run at least once)
d_cbp_data_country <- read_rds("./data/processed/cbp_nc_sector_totals_2001_2021.rds")
d_cbp_data_state <- read_rds("./data/processed/cbp_state_sector_totals_2001_2021.rds")

```

```{r}
est_size_class_levels = c("n1_4", "n5_9", "n10_19", "n20_49", "n50_99", "n100_249", "n250_499", "n500_999", 
                     "n1000")

emp_size_class_levels = c("e1_4", "e5_9", "e10_19", "e20_49", "e50_99", "e100_249", "e250_499", "e500_999", 
                     "e1000")

n_employees_ref <- tibble( # note: excluding n1000
  emp_size_class = est_size_class_levels,
  emp_class_count = c(2, 7, 15, 35, 75, 175, 375, 750, 2000),
  factor_order = 19
)

d_total_est_county <- d_cbp_data_country |>
  inner_join(d_fips_county_ref,
             by = c("fipstate" , "fipscty")) |>
  inner_join(d_naics_ref_2021,
             by = "naics") |>
  inner_join(d_naics_abbr_ref,
             by = "naics_descr") |>
  summarize(est = sum(est, na.rm = TRUE),
            n1_4 = sum(n1_4, na.rm = TRUE),
            n5_9 = sum(n5_9, na.rm = TRUE),
            n10_19 = sum(n10_19, na.rm = TRUE),
            n20_49 = sum(n20_49, na.rm = TRUE),
            n50_99 = sum(n50_99, na.rm = TRUE),
            n100_249 = sum(n100_249, na.rm = TRUE),
            n250_499 = sum(n250_499, na.rm = TRUE),
            n500_999 = sum(n500_999, na.rm = TRUE),
            n1000 = sum(n1000, na.rm = TRUE),
            .by = c(year, fipscty))

d_sector_totals_county_nc <- d_cbp_data_country |>
  mutate(avg_wage = (ap * 1000) / emp) |>
  inner_join(d_fips_county_ref,
             by = c("fipstate" , "fipscty")) |>
  inner_join(d_naics_ref_2021,
             by = "naics") |>
  inner_join(d_naics_abbr_ref,
             by = "naics_descr")

d_total_est_tate_nc <- d_cbp_data_state |>
  filter(fipstate == "37") |>
  inner_join(d_fips_state_ref,
             by = c("fipstate")) |>
  inner_join(d_naics_ref_2021,
             by = "naics") |>
  inner_join(d_naics_abbr_ref,
             by = "naics_descr") |>
  summarize(est = sum(est, na.rm = TRUE),
            n1_4 = sum(n1_4, na.rm = TRUE),
            n5_9 = sum(n5_9, na.rm = TRUE),
            n10_19 = sum(n10_19, na.rm = TRUE),
            n20_49 = sum(n20_49, na.rm = TRUE),
            n50_99 = sum(n50_99, na.rm = TRUE),
            n100_249 = sum(n100_249, na.rm = TRUE),
            n250_499 = sum(n250_499, na.rm = TRUE),
            n500_999 = sum(n500_999, na.rm = TRUE),
            n1000 = sum(n1000, na.rm = TRUE),
            .by = c("year")) |>
  pivot_longer(n1_4:n1000,
               names_to = "emp_size_class",
               values_to = "value") |>
  #filter(emp_size_class != "n1000") |>
  mutate(emp_size_class = as_factor(est_size_class_levels),
         emp_size_class = as.ordered(emp_size_class),
         pct = value / sum(value),
         .by = "year") |>
  filter(value > 0)

d_sector_totals_state_nc <- d_cbp_data_state |>
  filter(fipstate == "37") |>
  mutate(avg_wage = (ap * 1000) / emp) |>
  inner_join(d_fips_state_ref,
             by = c("fipstate")) |>
  inner_join(d_naics_ref_2021,
             by = "naics") |>
  inner_join(d_naics_abbr_ref,
             by = "naics_descr")

d_total_est_emp_usa <- d_cbp_data_state |>
  #filter(fipstate == "37") |>
  inner_join(d_fips_state_ref,
             by = c("fipstate")) |>
  inner_join(d_naics_ref_2021,
             by = "naics") |>
  inner_join(d_naics_abbr_ref,
             by = "naics_descr") |>
  summarize(est = sum(est, na.rm = TRUE),
            n1_4 = sum(n1_4, na.rm = TRUE),
            n5_9 = sum(n5_9, na.rm = TRUE),
            n10_19 = sum(n10_19, na.rm = TRUE),
            n20_49 = sum(n20_49, na.rm = TRUE),
            n50_99 = sum(n50_99, na.rm = TRUE),
            n100_249 = sum(n100_249, na.rm = TRUE),
            n250_499 = sum(n250_499, na.rm = TRUE),
            n500_999 = sum(n500_999, na.rm = TRUE),
            n1000 = sum(n1000, na.rm = TRUE),
            .by = c("year")) |>
  pivot_longer(n1_4:n1000,
               names_to = "emp_size_class",
               values_to = "value") |>
  #filter(emp_size_class != "n1000") |>
  mutate(emp_size_class = as_factor(est_size_class_levels),
         emp_size_class = as.ordered(emp_size_class),
         pct = value / sum(value),
         .by = "year") |>
  filter(value > 0)

# TODO: choose correct starting data
d_totals_usa <- d_cbp_data_state |>
  #filter(fipstate == "37") |>
  #mutate(avg_wage = (ap * 1000) / emp) |>
  inner_join(d_fips_state_ref,
             by = c("fipstate")) |>
  inner_join(d_naics_ref_2021,
             by = "naics") |>
  inner_join(d_naics_abbr_ref,
             by = "naics_descr") |>
  summarize(est = sum(est, na.rm = TRUE),
            n1_4 = sum(n1_4, na.rm = TRUE),
            n5_9 = sum(n5_9, na.rm = TRUE),
            n10_19 = sum(n10_19, na.rm = TRUE),
            n20_49 = sum(n20_49, na.rm = TRUE),
            n50_99 = sum(n50_99, na.rm = TRUE),
            n100_249 = sum(n100_249, na.rm = TRUE),
            n250_499 = sum(n250_499, na.rm = TRUE),
            n500_999 = sum(n500_999, na.rm = TRUE),
            n1000 = sum(n1000, na.rm = TRUE),
            .by = c("year", "naics", "naics_descr")
            ) |>
  pivot_longer(n1_4:n1000,
               names_to = "emp_size_class",
               values_to = "value") |>
  #filter(emp_size_class != "n1000") |>
  mutate(#emp_size_class = as_factor(est_size_class_levels),
         #emp_size_class = as.ordered(emp_size_class),
         pct = value / sum(value),
         .by = "year") |>
  filter(value > 0)

```

The County Business Patterns data includes counts of establishments by number of workers. The category names embed the range. For example, `n1_4` includes establishments reporting 1-4 employees. The category `n1000` includes establishments with 1,000 or more employees.

For simplicity's sake, the plots below that reference sectors use the sector abbreviations listed in @sec-tables.

<br>

## Number of establishments in NC

As one might expect, there are many more establishments with a small number of employees. Each subsequent employee size class includes fewer establishments.

```{r fig.height=6, fig.width=12}
#| label: fig-state-establishments-two-plot
#| fig-height: 6
#| fig-width: 12
#| fig-cap: "NC establishments 2021"
#| column: page-inset-right

p1 <- d_total_est_tate_nc |>
  filter(year == 2021) |>
  ggplot() +
  geom_col(aes(x = value, y = emp_size_class),
           fill = carolina_blue, alpha = 0.6) + 
  scale_x_continuous(labels = label_number(scale_cut = cut_short_scale())) +
  scale_y_discrete(limits=rev) +
  labs(
    x = "Establishments",
    y = "Employee size class",
    color = NULL,
  )

p2 <- d_total_est_tate_nc |>
  filter(year == 2021) |>
  inner_join(n_employees_ref,
             by = "emp_size_class") |>
  mutate(emp_size_class = fct_reorder(emp_size_class, pct)) |>
  arrange(desc(emp_size_class)) |>
  mutate(cum_pct = cumsum(pct),
         ybar_start = lag(cum_pct, default = 0)) |>
  ggplot() +
  geom_segment(aes(x = emp_size_class, xend = emp_size_class, y = ybar_start, yend = cum_pct),
           color = carolina_blue, linewidth = 8, alpha = 0.6) + 
  scale_y_continuous(labels = label_percent()) +
  scale_x_discrete(limits=rev) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  labs(
    x = "Employee size class",
    y = "Percent of establishments",
    color = NULL,
  )

p1 + p2 +
  plot_annotation(
    title = "NC establishments in each employee size class",
    subtitle = "2021; includes all sectors reported in CBP",
    caption = my_caption
  )

```

<br>

How does NC compare to the USA as a whole in the distribution of establishments? In general, quite similar.

```{r fig.height=6, fig.width=8}
#| label: fig-state-establishments-by-sector-pct-usa-compare
#| fig-height: 5
#| fig-width: 7
#| fig-cap: "NC establishements by sector compared to USA 2021"

xx_nc <- d_cbp_data_state |>
  filter(fipstate == "37",
         naics != "------") |> 
  select(year, naics, est) |>
  summarize(est = sum(est),
            .by = c("year", "naics")) |>
  mutate(est_pct = est / sum(est),
         .by = c("year"))

xx_usa <- d_cbp_data_state |>
  filter(naics != "------") |> 
  select(year, naics, est) |>
  summarize(est = sum(est),
            .by = c("year", "naics")) |>
  mutate(est_pct = est / sum(est),
         .by = c("year"))

nc_naics_abbr_levels <- xx_nc |>
  inner_join(d_naics_ref_2021,
             by = "naics") |>
  inner_join(d_naics_abbr_ref,
             by = "naics_descr") |>
  filter(year == 2021) |>
  arrange(est_pct) |>
  pull(naics_abbr)

data_for_plot <- xx_nc |>
  filter(year == 2021) |>
  mutate(scope = "nc") |>
  bind_rows(xx_usa |>
              filter(year == 2021) |>
              mutate(scope = "usa")
            ) |>
  inner_join(d_naics_ref_2021,
             by = "naics") |>
  inner_join(d_naics_abbr_ref,
             by = "naics_descr") |>
  select(-c(naics_abbr_num)) |>
  mutate(naics_abbr = factor(naics_abbr, levels = nc_naics_abbr_levels)) |>
  mutate(low_value = min(est_pct),
         high_value = max(est_pct),
         .by = naics_abbr) |>
  mutate(diff_pct = high_value - low_value,
         diff_pct = if_else(est_pct == high_value, diff_pct, -1 * diff_pct)) 

diff_pct_cutoff <- 0.005

data_for_plot |>
  ggplot() +
  geom_segment(aes(x = low_value, xend = high_value, y = naics_abbr, yend = naics_abbr),
               alpha = 0.3) +
  geom_point(aes(x = est_pct, y = naics_abbr, color = scope),
           alpha = 0.6) + 
  geom_point(aes(x = est_pct, y = naics_abbr, color = scope),
           alpha = 0.6) + 
  geom_text(aes(x = high_value, y = naics_abbr,
                label = if_else(diff_pct > diff_pct_cutoff,
                                percent(est_pct, accuracy = .1),
                                NA_character_)),
            na.rm = TRUE, size = 3,
            hjust = 0, nudge_x = 0.003) +
  geom_text(aes(x = low_value, y = naics_abbr,
                label = if_else(diff_pct < -1 * diff_pct_cutoff,
                                percent(est_pct, accuracy = .1),
                                NA_character_)),
            na.rm = TRUE, size = 3,
            hjust = 1, nudge_x = -0.003) +
  scale_x_continuous(labels = label_percent()) +
  scale_color_manual(values = c(carolina_blue, "firebrick")) +
  theme(legend.position = c(0.8, 0.4),
        legend.box.background = element_rect(fill = "grey80")) +
  labs(
    title = "NC establishments by sector\ncompared to USA 2021",
    subtitle = glue("Includes all 100 counties and 'Statewide'", 
                    "; showing percentages where difference is > {percent(diff_pct_cutoff, accuracy = 0.1)}"),
    x = "Establishements",
    y = "",
    color = NULL,
    caption = my_caption
  )

```

<br>

```{r fig.height=8, fig.width=12}
#| label: fig-state-establishments-naics-pct-two-plot
#| fig-height: 8
#| fig-width: 12
#| fig-cap: "Percent of NC establishments in each employee size class by sector 2021"
#| column: page-inset-right

data_for_plot <-  d_cbp_data_state |>
  filter(#year == 2021,
         fipstate == "37",
         naics != "------") |>
  select(year, fipstate, naics,
         est,
         starts_with("n"),
         -ends_with(c("F")),
         -emp) |>
  inner_join(d_naics_ref_2021,
             by = "naics") |>
  inner_join(d_naics_abbr_ref,
             by = "naics_descr") |>
  select(-c(naics_abbr_num)) |>
  pivot_longer(n1_4:n1000,
               names_to = "est_size_class",
               values_to = "value") |>
  mutate(#naics_abbr = fct_lump(naics_abbr, 9, w = value),
         est_size_class = factor(est_size_class, levels = est_size_class_levels)) |>
  mutate(pct_est = value / sum(value),
         .by = c("year"))

p1 <- data_for_plot |>
  filter(year == 2021) |>
  mutate(naics_abbr = fct_lump(naics_abbr, 9, w = value)) |>
  ggplot() +
  geom_col(aes(x = pct_est, y = est_size_class, fill = naics_abbr),
           alpha = 0.6, show.legend = FALSE) +
  scale_x_continuous(labels = label_percent(accuracy = 1)) +
  scale_y_discrete(limits=rev) +
  labs(
    x = "Percent of establishments",
    y = "Employee size class",
    color = NULL
  )

p2 <- data_for_plot |>
  filter(year == 2021) |>
  mutate(naics_abbr = fct_lump(naics_abbr, 9, w = value)) |>
  ggplot() +
  geom_col(aes(x = pct_est, y = est_size_class, fill = naics_abbr),
           alpha = 0.6, position = position_fill()) +
  scale_x_continuous(labels = label_percent(accuracy = 1)) +
  scale_y_discrete(limits=rev) +
  labs(
    x = "Distribution of size classes",
    y = "Employee size class",
    color = NULL
  )

p3 <- data_for_plot |>
  filter(year == 2021) |>
  mutate(naics_abbr = fct_reorder(naics_abbr, pct_est, sum)) |>
  ggplot() +
  geom_col(aes(y = naics_abbr, x = pct_est, fill = est_size_class),
           alpha = 0.6, show.legend = FALSE) +
  scale_x_continuous(labels = label_percent(accuracy = 1)) +
  scale_fill_viridis_d(end = 0.85) +
  labs(
    x = "Percent of establishments",
    y = NULL,
    color = NULL
  )

p4 <- data_for_plot |>
  filter(year == 2021) |>
  mutate(naics_abbr = fct_reorder(naics_abbr, pct_est, sum)) |>
  ggplot() +
  geom_col(aes(y = naics_abbr, x = pct_est, fill = est_size_class),
           alpha = 0.6,position = position_fill()) +
  scale_x_continuous(labels = label_percent(accuracy = 1)) +
  scale_fill_viridis_d(end = 0.85) +
  labs(
    x = "Distribution of NAICS categories",
    y = NULL,
    color = NULL
  )

(p1 + p2) / (p3 + p4) +
  plot_annotation(
    title = "Percent of NC establishments in each employee size class by sector",
    subtitle = "2021; includes all sectors reported in CBP",
    caption = my_caption
  )
  
```

<br>

How has the portion of establishments changed over time?

```{r fig.height=8, fig.width=10}
#| label: fig-state-establishments-pct-timeseries
#| fig-height: 8
#| fig-width: 10
#| fig-cap: "Percent of NC establishments by employee size class 2001-2021 for top sectors"
#| column: page-inset-right

# TODO: should I lump on 2021 top sectors? (currently considering whole time range)

data_for_plot |>
  mutate(naics_abbr = fct_lump(naics_abbr, 9, w = value)) |>
  filter(naics_abbr != "Other") |>
  ggplot() +
  geom_line(aes(x = year, y = pct_est, color = est_size_class, group = est_size_class),
           linewidth = 0.4, alpha = 0.6) +
  scale_y_continuous(labels = label_percent(accuracy = 0.1)) +
  facet_wrap(. ~ naics_abbr, scales = "free_y") +
  guides(color = guide_legend(override.aes = c(linewidth = 3))) +
  labs(
    title = "Percent of NC establishements in each employee size class\nby sector 2001-2021",
    subtitle = "Top 9 sectors by number of establishments (in 2021) as reported in CBP",
    x = "",
    y = "Percent of establishments (scale varies)",
    color = NULL,
    caption = my_caption
  )

```

<br>

```{r}
knitr::knit_exit()

```

<br>

